<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Elasticsearch篇之深入了解Search的运行机制 | Jiavg</title><meta name="description" content="Elasticsearch篇之深入了解Search的运行机制"><meta name="keywords" content="ElasticSearch,Search运行机制"><meta name="author" content="Jiavg"><meta name="copyright" content="Jiavg"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Elasticsearch篇之深入了解Search的运行机制"><meta name="twitter:description" content="Elasticsearch篇之深入了解Search的运行机制"><meta name="twitter:image" content="https://jiavag.github.io/img/bg/1.png"><meta property="og:type" content="article"><meta property="og:title" content="Elasticsearch篇之深入了解Search的运行机制"><meta property="og:url" content="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC7%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3Search%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><meta property="og:site_name" content="Jiavg"><meta property="og:description" content="Elasticsearch篇之深入了解Search的运行机制"><meta property="og:image" content="https://jiavag.github.io/img/bg/1.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC7%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3Search%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><link rel="prev" title="Elasticsearch篇之聚合分析入门" href="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC8%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/"><link rel="next" title="Elasticsearch篇之分布式特性" href="https://jiavag.github.io/2020/04/11/Elastic%20Search/%E7%AC%AC6%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%B9%E6%80%A7/"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6386517046719934',
  enable_page_level_ads: 'true'
});</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://www.lylgjiavg.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: Jiavg","link":"链接: ","source":"来源: Jiavg","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'true',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">38</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">29</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Elasticsearch篇之深入了解Search的运行机制"><span class="toc-number">1.</span> <span class="toc-text">Elasticsearch篇之深入了解Search的运行机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Search的运行机制"><span class="toc-number">1.1.</span> <span class="toc-text">Search的运行机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Query阶段"><span class="toc-number">1.1.1.</span> <span class="toc-text">Query阶段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fetch阶段"><span class="toc-number">1.1.2.</span> <span class="toc-text">Fetch阶段</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#相关性算分问题"><span class="toc-number">1.2.</span> <span class="toc-text">相关性算分问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题引出"><span class="toc-number">1.2.1.</span> <span class="toc-text">问题引出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决思路"><span class="toc-number">1.2.2.</span> <span class="toc-text">解决思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#排序"><span class="toc-number">1.3.</span> <span class="toc-text">排序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#字符串排序"><span class="toc-number">1.3.1.</span> <span class="toc-text">字符串排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#排序过程"><span class="toc-number">1.3.2.</span> <span class="toc-text">排序过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Fielddata"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">Fielddata</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Doc-Values"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">Doc Values</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#docvalues-fields"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">docvalues_fields</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分页与遍历"><span class="toc-number">1.4.</span> <span class="toc-text">分页与遍历</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#From-Size"><span class="toc-number">1.4.1.</span> <span class="toc-text">From&#x2F;Size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#深度分页"><span class="toc-number">1.4.2.</span> <span class="toc-text">深度分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scroll"><span class="toc-number">1.4.3.</span> <span class="toc-text">Scroll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Search-After"><span class="toc-number">1.4.4.</span> <span class="toc-text">Search_After</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#应用场景"><span class="toc-number">1.4.5.</span> <span class="toc-text">应用场景</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/bg/1.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Jiavg</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Elasticsearch篇之深入了解Search的运行机制</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-12 00:19:47"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-12</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-04-15 01:37:02"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-15</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Elastic-Stack/">Elastic Stack</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="Elasticsearch篇之深入了解Search的运行机制"><a href="#Elasticsearch篇之深入了解Search的运行机制" class="headerlink" title="Elasticsearch篇之深入了解Search的运行机制"></a>Elasticsearch篇之深入了解Search的运行机制</h1><h2 id="Search的运行机制"><a href="#Search的运行机制" class="headerlink" title="Search的运行机制"></a>Search的运行机制</h2><ul>
<li>Search执行的时候实际分为两个步骤运作的<ul>
<li>Query阶段</li>
<li>Fetch阶段</li>
</ul>
</li>
<li>Query-Then-Fetch</li>
</ul>
<h3 id="Query阶段"><a href="#Query阶段" class="headerlink" title="Query阶段"></a>Query阶段</h3><ul>
<li><p>Node3在接收到用户的search请求后, 会先进行Query阶段 (此时Coordinating Node角色)</p>
<ol>
<li>node3在6个主副分片中随机选择3个分片, 发送search request</li>
<li>被选中的3个分片会分别执行查询并排序, 返回from + size个文档Id和排序值</li>
<li>node3整合3个分片返回的from + size个文档Id, 根据排序值排序后选取<code>from 到 (from + size)</code>(共size个)的文档Id</li>
</ol>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/bhsYp2PTc6XGyvB.jpg"  alt="2020-04-12_003418"></p>
</li>
</ul>
<h3 id="Fetch阶段"><a href="#Fetch阶段" class="headerlink" title="Fetch阶段"></a>Fetch阶段</h3><ul>
<li><p>Node3根据Query阶段获取的文档Id列表去对应的shard上获取文档详情数据</p>
<ol>
<li>node3向相关的分片发送multi_get请求</li>
<li>3个分片返回文档详细数据</li>
<li>node3拼接返回的结果并返回给客户</li>
</ol>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/CsLEZ2XzJxUq4lG.jpg"  alt="2020-04-12_003912"></p>
</li>
</ul>
<h2 id="相关性算分问题"><a href="#相关性算分问题" class="headerlink" title="相关性算分问题"></a>相关性算分问题</h2><ul>
<li>相关性算分在shard与shard之间是相互独立的, 也就意味着同一个Term的IDF等值在不同shard上是不同的.文档的相关性算分和他所处的shard相关</li>
<li>在文档数量不多时, 会导致相关性算分严重不准的情况</li>
</ul>
<h3 id="问题引出"><a href="#问题引出" class="headerlink" title="问题引出"></a>问题引出</h3><ol>
<li><p>首先, 在ES中插入如下文档</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">POST test_search_relevance/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "name": "hello"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">POST test_search_relevance/doc/2</span><br><span class="line">&#123;</span><br><span class="line">  "name": "hello, world"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">POST test_search_relevance/doc/3</span><br><span class="line">&#123;</span><br><span class="line">  "name": "hello, world. a beatiful word"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询插入的索引<code>test_search_relevance</code>默认配置, 及文档插入的正确性</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"number_of_shards"</span>值为5, 说明es默认创建的索引shard数为5</span></span><br><span class="line">&#123;</span><br><span class="line">  "test_search_relevance": &#123;</span><br><span class="line">    "aliases": &#123;&#125;,</span><br><span class="line">    "mappings": &#123;</span><br><span class="line">      "doc": &#123;</span><br><span class="line">        "properties": &#123;</span><br><span class="line">          "name": &#123;</span><br><span class="line">            "type": "text",</span><br><span class="line">            "fields": &#123;</span><br><span class="line">              "keyword": &#123;</span><br><span class="line">                "type": "keyword",</span><br><span class="line">                "ignore_above": 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "settings": &#123;</span><br><span class="line">      "index": &#123;</span><br><span class="line">        "creation_date": "1586624049883",</span><br><span class="line">        "number_of_shards": "5",</span><br><span class="line">        "number_of_replicas": "1",</span><br><span class="line">        "uuid": "liS9BY-ERzG6hR4pezVNCw",</span><br><span class="line">        "version": &#123;</span><br><span class="line">          "created": "6010199"</span><br><span class="line">        &#125;,</span><br><span class="line">        "provided_name": "test_search_relevance"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance/_search</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 19,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 3,</span><br><span class="line">    "max_score": 1,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world. a beatiful word"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在目标索引查询<code>name</code>字段, 查询内容为<code>hello</code>, 分析查询结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "name": "hello"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 由查询结果可以看出查询的结果并非我们预期的那样(hello应该在最前面)</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 14,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 3,</span><br><span class="line">    "max_score": 0.2876821,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 0.2876821,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 0.2876821,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 0.2876821,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world. a beatiful word"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>由步骤3我们发现, 查询结果发现所有的文档得分值一样, 并非我们的预期(hello应该在最前面), 于是我们在查询字段添加<code>explain: true</code>条件来查看具体的查询算分过程.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance/_search</span><br><span class="line">&#123;</span><br><span class="line">  "explain": true, </span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "name": "hello"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时我们发现, 由于文档分散在不同的shard上(<span class="string">"_shard"</span>字段显示shard值), 故其直接影响到了</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docFreq的取值(此时都为1), 进而影响到了相关性算分</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 27,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 3,</span><br><span class="line">    "max_score": 0.2876821,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][2]",</span><br><span class="line">        "_node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 0.2876821,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.2876821,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.2876821,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.2876821,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 1,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][3]",</span><br><span class="line">        "_node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 0.2876821,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.2876821,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.2876821,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.2876821,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 1,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][4]",</span><br><span class="line">        "_node": "WIUsESqiTZqLs_4nQTvbeQ",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 0.2876821,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world. a beatiful word"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.2876821,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.2876821,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.2876821,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 1,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 5,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 5,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><ul>
<li><p>设置分片数为1个, 从根本上排除问题, 在文档数数量不多的时候可以考虑该方案, 比如百万级别到千万级别的文档.</p>
<p>过程:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.设置分片数为1</span></span><br><span class="line">PUT test_search_relevance</span><br><span class="line">&#123;</span><br><span class="line">  "settings": &#123;</span><br><span class="line">    "index": &#123;</span><br><span class="line">      "number_of_shards": 1</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.插入测试数据</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">POST test_search_relevance/doc/1</span><br><span class="line">&#123;</span><br><span class="line">  "name": "hello"</span><br><span class="line">&#125;</span><br><span class="line">POST test_search_relevance/doc/2</span><br><span class="line">&#123;</span><br><span class="line">  "name": "hello, world"</span><br><span class="line">&#125;</span><br><span class="line">POST test_search_relevance/doc/3</span><br><span class="line">&#123;</span><br><span class="line">  "name": "hello, world. a beatiful word"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.查询数据</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance/_search</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "name": "hello"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 69,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 1,</span><br><span class="line">    "successful": 1,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 3,</span><br><span class="line">    "max_score": 0.17940095,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 0.17940095,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 0.14874382,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 0.09833273,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world. a beatiful word"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上例查询结果可以看出, 设置shard数为1可以解决相关性算分问题.</p>
<p>另附<code>explain: true</code>查询</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance/_search</span><br><span class="line">&#123;</span><br><span class="line">  "explain": true, </span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "name": "hello"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 8,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 1,</span><br><span class="line">    "successful": 1,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 3,</span><br><span class="line">    "max_score": 0.17940095,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][0]",</span><br><span class="line">        "_node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 0.17940095,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.17940095,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.17940095,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.13353139,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 1.3435115,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2.6666667,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][0]",</span><br><span class="line">        "_node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 0.14874382,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.14874382,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.14874382,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.13353139,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 1.113924,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2.6666667,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][0]",</span><br><span class="line">        "_node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 0.09833273,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world. a beatiful word"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.09833273,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.09833273,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.13353139,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.7364016,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2.6666667,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 5,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>使用DFS Query-Then-Fetch</p>
<ul>
<li>在不设置默认shard的情况下, 使用<code>dfs_query_then_fetch</code>参数来解决此问题</li>
<li>DFS Query-Then-Fetch是在拿到所有文档后再重新计算完整的计算一次相关性得分, 耗费更多的CPU和内存, 执行性能也比较低, 一般不建议使用. 使用方式如下:</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 此查询在问题引出的环境下测试(即未设置number_of_shard参数)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance/_search?search_type=dfs_query_then_fetch</span><br><span class="line">&#123;</span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "name": "hello"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 143,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 3,</span><br><span class="line">    "max_score": 0.17940095,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 0.17940095,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 0.14874382,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 0.09833273,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world. a beatiful word"</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>附带<code>explain:true</code>的查询过程:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET test_search_relevance/_search?search_type=dfs_query_then_fetch</span><br><span class="line">&#123;</span><br><span class="line">  "explain": true, </span><br><span class="line">  "query": &#123;</span><br><span class="line">    "match": &#123;</span><br><span class="line">      "name": "hello"</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 42,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 3,</span><br><span class="line">    "max_score": 0.17940095,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][3]",</span><br><span class="line">        "_node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 0.17940095,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.17940095,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.17940095,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.13353139,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 1.3435115,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2.6666667,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][2]",</span><br><span class="line">        "_node": "-eS9ksggR-SI6NKJRLkOeQ",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 0.14874382,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.14874382,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.14874382,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.13353139,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 1.113924,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2.6666667,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_shard": "[test_search_relevance][4]",</span><br><span class="line">        "_node": "WIUsESqiTZqLs_4nQTvbeQ",</span><br><span class="line">        "_index": "test_search_relevance",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 0.09833273,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "name": "hello, world. a beatiful word"</span><br><span class="line">        &#125;,</span><br><span class="line">        "_explanation": &#123;</span><br><span class="line">          "value": 0.09833273,</span><br><span class="line">          "description": "weight(name:hello in 0) [PerFieldSimilarity], result of:",</span><br><span class="line">          "details": [</span><br><span class="line">            &#123;</span><br><span class="line">              "value": 0.09833273,</span><br><span class="line">              "description": "score(doc=0,freq=1.0 = termFreq=1.0\n), product of:",</span><br><span class="line">              "details": [</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.13353139,</span><br><span class="line">                  "description": "idf, computed as log(1 + (docCount - docFreq + 0.5) / (docFreq + 0.5)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docFreq",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 3,</span><br><span class="line">                      "description": "docCount",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                  "value": 0.7364016,</span><br><span class="line">                  "description": "tfNorm, computed as (freq * (k1 + 1)) / (freq + k1 * (1 - b + b * fieldLength / avgFieldLength)) from:",</span><br><span class="line">                  "details": [</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1,</span><br><span class="line">                      "description": "termFreq=1.0",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 1.2,</span><br><span class="line">                      "description": "parameter k1",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 0.75,</span><br><span class="line">                      "description": "parameter b",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 2.6666667,</span><br><span class="line">                      "description": "avgFieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                      "value": 5,</span><br><span class="line">                      "description": "fieldLength",</span><br><span class="line">                      "details": []</span><br><span class="line">                    &#125;</span><br><span class="line">                  ]</span><br><span class="line">                &#125;</span><br><span class="line">              ]</span><br><span class="line">            &#125;</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><ul>
<li><p>es默认会采用相关性算分排序, 用户可以通过设定sorting参数来自行设定排序规则</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/13ZKYFI6Atmib2g.jpg"  alt="2020-04-12_013411"></p>
</li>
<li><p>按照多个字段排序</p>
<p>GET /test_search_index/_search<br>{<br>  “sort”: [</p>
<pre><code>{
  &quot;birth&quot;: {
    &quot;order&quot;: &quot;desc&quot;
  },
  &quot;_score&quot;: {
    &quot;order&quot;: &quot;desc&quot;
  },
  &quot;_doc&quot;: {
    &quot;order&quot;: &quot;desc&quot;
  }
}</code></pre><p>  ]<br>}</p>
<p>示例1:</p>
<p>使用的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST test_search_index/doc/_bulk</span><br><span class="line">&#123;"index":&#123;"_id":"1"&#125;&#125;</span><br><span class="line">&#123;"username":"alfred way","job":"java engineer","age":18,"birth":"1990-01-02","isMarried":false&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"2"&#125;&#125;</span><br><span class="line">&#123;"username":"alfred","job":"java senior engineer and java specialist","age":28,"birth":"1980-05-07","isMarried":true&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"3"&#125;&#125;</span><br><span class="line">&#123;"username":"lee","job":"java and ruby engineer","age":22,"birth":"1985-08-07","isMarried":false&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"4"&#125;&#125;</span><br><span class="line">&#123;"username":"alfred junior way","job":"ruby engineer","age":23,"birth":"1989-08-07","isMarried":false&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "birth": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在使用sort排序时, 默认的按照相关性算分排序就失效了, 故该查询没有计算文档的相关性得分</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="string">"_score"</span>: null</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 405,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": null,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred way",</span><br><span class="line">          "job": "java engineer",</span><br><span class="line">          "age": 18,</span><br><span class="line">          "birth": "1990-01-02",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          631238400000</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "4",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred junior way",</span><br><span class="line">          "job": "ruby engineer",</span><br><span class="line">          "age": 23,</span><br><span class="line">          "birth": "1989-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          618451200000</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "lee",</span><br><span class="line">          "job": "java and ruby engineer",</span><br><span class="line">          "age": 22,</span><br><span class="line">          "birth": "1985-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          492220800000</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred",</span><br><span class="line">          "job": "java senior engineer and java specialist",</span><br><span class="line">          "age": 28,</span><br><span class="line">          "birth": "1980-05-07",</span><br><span class="line">          "isMarried": true</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          326505600000</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例2:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "birth": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;,</span><br><span class="line">      "_score": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;,</span><br><span class="line">      "_doc": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 由于此排序用到了_score字段, 故es对其文档进行了相关性算分</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 72,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": null,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred way",</span><br><span class="line">          "job": "java engineer",</span><br><span class="line">          "age": 18,</span><br><span class="line">          "birth": "1990-01-02",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          631238400000,</span><br><span class="line">          1,</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "4",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred junior way",</span><br><span class="line">          "job": "ruby engineer",</span><br><span class="line">          "age": 23,</span><br><span class="line">          "birth": "1989-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          618451200000,</span><br><span class="line">          1,</span><br><span class="line">          1</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "lee",</span><br><span class="line">          "job": "java and ruby engineer",</span><br><span class="line">          "age": 22,</span><br><span class="line">          "birth": "1985-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          492220800000,</span><br><span class="line">          1,</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred",</span><br><span class="line">          "job": "java senior engineer and java specialist",</span><br><span class="line">          "age": 28,</span><br><span class="line">          "birth": "1980-05-07",</span><br><span class="line">          "isMarried": true</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          326505600000,</span><br><span class="line">          1,</span><br><span class="line">          0</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="字符串排序"><a href="#字符串排序" class="headerlink" title="字符串排序"></a>字符串排序</h3><ul>
<li><p>按照字符串排序比较特殊, 因为es有text 和keyword两种类型, 针对text类型排序, 如下所示:</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/zkCu5yc1EPLsmwO.jpg"  alt="2020-04-12_020724"></p>
</li>
</ul>
<h3 id="排序过程"><a href="#排序过程" class="headerlink" title="排序过程"></a>排序过程</h3><ul>
<li><p>排序的过程实质是对字段原始内容排序的过程, 这个过程中倒排索引无法发挥作用, 需要用到正排索引, 也就是通过文档Id和字段可以快速得到字段原始内容.</p>
</li>
<li><p>es对此提供了2种实现方式:</p>
<ul>
<li>fielddata (默认禁用)</li>
<li>doc values (默认启用, 且对text类型无效)</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/15/GB7oF9rplC1cb4g.jpg"  alt="2020-04-12_021220"></p>
</li>
</ul>
<h4 id="Fielddata"><a href="#Fielddata" class="headerlink" title="Fielddata"></a>Fielddata</h4><ul>
<li><p>fielddata默认是关闭的, 可以通过如下api开启:</p>
<ul>
<li>此时字符串是按照分词后的term排序, 往往结果很难符合预期</li>
<li>一般是在对分词做聚合分析的时候开启</li>
</ul>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/1cdRaIr2sLuTeOX.jpg"  alt="2020-04-12_021452" style="zoom:80%;" />

<p>演示(注意执行流程):</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "username": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "username": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.response</span></span><br><span class="line">&#123;</span><br><span class="line">  "error": &#123;</span><br><span class="line">    "root_cause": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type": "illegal_argument_exception",</span><br><span class="line">        "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [username] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    "type": "search_phase_execution_exception",</span><br><span class="line">    "reason": "all shards failed",</span><br><span class="line">    "phase": "query",</span><br><span class="line">    "grouped": true,</span><br><span class="line">    "failed_shards": [</span><br><span class="line">      &#123;</span><br><span class="line">        "shard": 0,</span><br><span class="line">        "index": "test_search_index",</span><br><span class="line">        "node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "reason": &#123;</span><br><span class="line">          "type": "illegal_argument_exception",</span><br><span class="line">          "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [username] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "status": 400</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.request</span></span><br><span class="line">PUT /test_search_index/_mapping/doc</span><br><span class="line">&#123;</span><br><span class="line">  "properties": &#123;</span><br><span class="line">    "username": &#123;</span><br><span class="line">      "type": "text", </span><br><span class="line">      "fielddata": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "username": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 53,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": null,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "4",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred junior way",</span><br><span class="line">          "job": "ruby engineer",</span><br><span class="line">          "age": 23,</span><br><span class="line">          "birth": "1989-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          "way"</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred way",</span><br><span class="line">          "job": "java engineer",</span><br><span class="line">          "age": 18,</span><br><span class="line">          "birth": "1990-01-02",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          "way"</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "lee",</span><br><span class="line">          "job": "java and ruby engineer",</span><br><span class="line">          "age": 22,</span><br><span class="line">          "birth": "1985-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          "lee"</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred",</span><br><span class="line">          "job": "java senior engineer and java specialist",</span><br><span class="line">          "age": 28,</span><br><span class="line">          "birth": "1980-05-07",</span><br><span class="line">          "isMarried": true</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          "alfred"</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Doc-Values"><a href="#Doc-Values" class="headerlink" title="Doc Values"></a>Doc Values</h4><ul>
<li><p>Doc Values默认是启用的, 可以在创建索引的时候关闭</p>
<ul>
<li>如果后面要再开启doc values, <strong>需要reindex操作</strong></li>
</ul>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/A84Xf2DKSoV37dm.jpg"  alt="2020-04-12_022248" style="zoom: 80%;" />

</li>
</ul>
<h4 id="docvalues-fields"><a href="#docvalues-fields" class="headerlink" title="docvalues_fields"></a>docvalues_fields</h4><ul>
<li><p>可以通过该字段获取fielddata或者doc values中储存的内容</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/qILkyJ7YUtv5AuC.jpg"  alt="2020-04-12_022456" style="zoom:80%;" />

<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">PUT /test_search_index/_mapping/doc</span><br><span class="line">&#123;</span><br><span class="line">  "properties": &#123;</span><br><span class="line">    "username": &#123;</span><br><span class="line">      "type": "text", </span><br><span class="line">      "fielddata": false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "docvalue_fields": [</span><br><span class="line">      "username",</span><br><span class="line">      "birth",</span><br><span class="line">      "age"</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 15,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 2,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 3,</span><br><span class="line">    "failures": [</span><br><span class="line">      &#123;</span><br><span class="line">        "shard": 2,</span><br><span class="line">        "index": "test_search_index",</span><br><span class="line">        "node": "WIUsESqiTZqLs_4nQTvbeQ",</span><br><span class="line">        "reason": &#123;</span><br><span class="line">          "type": "illegal_argument_exception",</span><br><span class="line">          "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [username] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": 1,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">PUT /test_search_index/_mapping/doc</span><br><span class="line">&#123;</span><br><span class="line">  "properties": &#123;</span><br><span class="line">    "username": &#123;</span><br><span class="line">      "type": "text", </span><br><span class="line">      "fielddata": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "docvalue_fields": [</span><br><span class="line">      "username",</span><br><span class="line">      "birth",</span><br><span class="line">      "age"</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 48,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": 1,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred",</span><br><span class="line">          "job": "java senior engineer and java specialist",</span><br><span class="line">          "age": 28,</span><br><span class="line">          "birth": "1980-05-07",</span><br><span class="line">          "isMarried": true</span><br><span class="line">        &#125;,</span><br><span class="line">        "fields": &#123;</span><br><span class="line">          "birth": [</span><br><span class="line">            "1980-05-07T00:00:00.000Z"</span><br><span class="line">          ],</span><br><span class="line">          "age": [</span><br><span class="line">            28</span><br><span class="line">          ],</span><br><span class="line">          "username": [</span><br><span class="line">            "alfred"</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "4",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred junior way",</span><br><span class="line">          "job": "ruby engineer",</span><br><span class="line">          "age": 23,</span><br><span class="line">          "birth": "1989-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "fields": &#123;</span><br><span class="line">          "birth": [</span><br><span class="line">            "1989-08-07T00:00:00.000Z"</span><br><span class="line">          ],</span><br><span class="line">          "age": [</span><br><span class="line">            23</span><br><span class="line">          ],</span><br><span class="line">          "username": [</span><br><span class="line">            "alfred",</span><br><span class="line">            "junior",</span><br><span class="line">            "way"</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred way",</span><br><span class="line">          "job": "java engineer",</span><br><span class="line">          "age": 18,</span><br><span class="line">          "birth": "1990-01-02",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "fields": &#123;</span><br><span class="line">          "birth": [</span><br><span class="line">            "1990-01-02T00:00:00.000Z"</span><br><span class="line">          ],</span><br><span class="line">          "age": [</span><br><span class="line">            18</span><br><span class="line">          ],</span><br><span class="line">          "username": [</span><br><span class="line">            "alfred",</span><br><span class="line">            "way"</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "lee",</span><br><span class="line">          "job": "java and ruby engineer",</span><br><span class="line">          "age": 22,</span><br><span class="line">          "birth": "1985-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "fields": &#123;</span><br><span class="line">          "birth": [</span><br><span class="line">            "1985-08-07T00:00:00.000Z"</span><br><span class="line">          ],</span><br><span class="line">          "age": [</span><br><span class="line">            22</span><br><span class="line">          ],</span><br><span class="line">          "username": [</span><br><span class="line">            "lee"</span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h2 id="分页与遍历"><a href="#分页与遍历" class="headerlink" title="分页与遍历"></a>分页与遍历</h2><ul>
<li>es提供了3种方式来解决分页与遍历的问题<ul>
<li>from/size</li>
<li>scroll</li>
<li>search_after</li>
</ul>
</li>
</ul>
<h3 id="From-Size"><a href="#From-Size" class="headerlink" title="From/Size"></a>From/Size</h3><ul>
<li><p>最常用的分页方案</p>
<ul>
<li>from指明开始位置</li>
<li>size指明获取总数</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/ypFYAzNg2virmd9.jpg"  alt="2020-04-12_024126"></p>
</li>
</ul>
<h3 id="深度分页"><a href="#深度分页" class="headerlink" title="深度分页"></a>深度分页</h3><ul>
<li><p>深度分页是一个经典的问题: 在数据分片存储的情况下如何获取前1000个文档?</p>
<ul>
<li>获取从990~1000的文档时, 会在每个分片上都先获取1000个文档, 然后由Coordinating Node聚合所有的分片的结果再排序选取前1000个文档.</li>
<li>页数越深, 处理文档越多, 占用内存越多, 耗时越长. 尽量避免深度分页, es通过index.max_result_window限定最多到10000条数据</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/ivFzK4JuwpIkycU.jpg"  alt="2020-04-12_024729"></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "from": 2,</span><br><span class="line">  "size": 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 8,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": 1,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred way",</span><br><span class="line">          "job": "java engineer",</span><br><span class="line">          "age": 18,</span><br><span class="line">          "birth": "1990-01-02",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "lee",</span><br><span class="line">          "job": "java and ruby engineer",</span><br><span class="line">          "age": 22,</span><br><span class="line">          "birth": "1985-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "from": 10000,</span><br><span class="line">  "size": 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "error": &#123;</span><br><span class="line">    "root_cause": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type": "query_phase_execution_exception",</span><br><span class="line">        "reason": "Result window is too large, from + size must be less than or equal to: [10000] but was [10002]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting."</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    "type": "search_phase_execution_exception",</span><br><span class="line">    "reason": "all shards failed",</span><br><span class="line">    "phase": "query",</span><br><span class="line">    "grouped": true,</span><br><span class="line">    "failed_shards": [</span><br><span class="line">      &#123;</span><br><span class="line">        "shard": 0,</span><br><span class="line">        "index": "test_search_index",</span><br><span class="line">        "node": "95bEF7jnS0uGrVlP6cA7Dw",</span><br><span class="line">        "reason": &#123;</span><br><span class="line">          "type": "query_phase_execution_exception",</span><br><span class="line">          "reason": "Result window is too large, from + size must be less than or equal to: [10000] but was [10002]. See the scroll api for a more efficient way to request large data sets. This limit can be set by changing the [index.max_result_window] index level setting."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "status": 500</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Scroll"><a href="#Scroll" class="headerlink" title="Scroll"></a>Scroll</h3><ul>
<li><p>遍历文档集的api, 以快照的方式来避免深度分页的问题</p>
<ul>
<li>不能用来做实时搜索, 因为数据不是实时的</li>
<li>尽量不要使用复杂的sort条件, 使用_doc最高效</li>
<li>使用稍显复杂</li>
</ul>
</li>
<li><p>使用示例</p>
<ol>
<li>第一步需要发起一个scroll search, 如下所示:<ul>
<li>es在收到该请求后会根据查询条件创建文档Id合集的快照</li>
</ul>
</li>
</ol>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/wNlcisoQV4RLd1O.jpg"  alt="2020-04-12_030159"></p>
<ol start="2">
<li><p>第二步调用scroll search的api, 获取文档集合, 如下所示:</p>
<ul>
<li>不断迭代调用直到hits.hits数组为空时停止</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/mSs2yw5jhoW6IzN.jpg"  alt="2020-04-12_030403"></p>
</li>
</ol>
<p>演示示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search?scroll=5m</span><br><span class="line">&#123;</span><br><span class="line">  "size": 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "_scroll_id": "DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAA_FldJVXNFU3FpVFpxTHNfNG5RVHZiZVEAAAAAAAAAPhY5NWJFRjdqblMwdUdyVmxQNmNBN0R3AAAAAAAAAD0WV0lVc0VTcWlUWnFMc180blFUdmJlUQAAAAAAAAA4Fi1lUzlrc2dnUi1TSTZOS0pSTGtPZVEAAAAAAAAAPhZXSVVzRVNxaVRacUxzXzRuUVR2YmVR",</span><br><span class="line">  "took": 12,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": 1,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred",</span><br><span class="line">          "job": "java senior engineer and java specialist",</span><br><span class="line">          "age": 28,</span><br><span class="line">          "birth": "1980-05-07",</span><br><span class="line">          "isMarried": true</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "4",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred junior way",</span><br><span class="line">          "job": "ruby engineer",</span><br><span class="line">          "age": 23,</span><br><span class="line">          "birth": "1989-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">POST _search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  "scroll": "5m",</span><br><span class="line">  "scroll_id": "DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAA_FldJVXNFU3FpVFpxTHNfNG5RVHZiZVEAAAAAAAAAPhY5NWJFRjdqblMwdUdyVmxQNmNBN0R3AAAAAAAAAD0WV0lVc0VTcWlUWnFMc180blFUdmJlUQAAAAAAAAA4Fi1lUzlrc2dnUi1TSTZOS0pSTGtPZVEAAAAAAAAAPhZXSVVzRVNxaVRacUxzXzRuUVR2YmVR"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "_scroll_id": "DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAA_FldJVXNFU3FpVFpxTHNfNG5RVHZiZVEAAAAAAAAAPhY5NWJFRjdqblMwdUdyVmxQNmNBN0R3AAAAAAAAAD0WV0lVc0VTcWlUWnFMc180blFUdmJlUQAAAAAAAAA4Fi1lUzlrc2dnUi1TSTZOS0pSTGtPZVEAAAAAAAAAPhZXSVVzRVNxaVRacUxzXzRuUVR2YmVR",</span><br><span class="line">  "took": 13,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": 1,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred way",</span><br><span class="line">          "job": "java engineer",</span><br><span class="line">          "age": 18,</span><br><span class="line">          "birth": "1990-01-02",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": 1,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "lee",</span><br><span class="line">          "job": "java and ruby engineer",</span><br><span class="line">          "age": 22,</span><br><span class="line">          "birth": "1985-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">POST _search/scroll</span><br><span class="line">&#123;</span><br><span class="line">  "scroll": "5m",</span><br><span class="line">  "scroll_id": "DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAA_FldJVXNFU3FpVFpxTHNfNG5RVHZiZVEAAAAAAAAAPhY5NWJFRjdqblMwdUdyVmxQNmNBN0R3AAAAAAAAAD0WV0lVc0VTcWlUWnFMc180blFUdmJlUQAAAAAAAAA4Fi1lUzlrc2dnUi1TSTZOS0pSTGtPZVEAAAAAAAAAPhZXSVVzRVNxaVRacUxzXzRuUVR2YmVR"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "_scroll_id": "DnF1ZXJ5VGhlbkZldGNoBQAAAAAAAAA_FldJVXNFU3FpVFpxTHNfNG5RVHZiZVEAAAAAAAAAPhY5NWJFRjdqblMwdUdyVmxQNmNBN0R3AAAAAAAAAD0WV0lVc0VTcWlUWnFMc180blFUdmJlUQAAAAAAAAA4Fi1lUzlrc2dnUi1TSTZOS0pSTGtPZVEAAAAAAAAAPhZXSVVzRVNxaVRacUxzXzRuUVR2YmVR",</span><br><span class="line">  "took": 6,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": 1,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>过多的scroll调用会占用大量的内存, 可以通过clear api删除过多的scroll快照:</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/hkcb7aHlg4ABiNP.jpg"  alt="2020-04-12_031216" style="zoom:80%;" />

</li>
</ul>
<h3 id="Search-After"><a href="#Search-After" class="headerlink" title="Search_After"></a>Search_After</h3><ul>
<li><p>避免了深度分页的性能问题, 提供实时的下一页文档获取功能</p>
<ul>
<li>缺点是不能使用from参数, 即不能指定页数</li>
<li>只能下一页, 不能上一页</li>
<li>使用简单</li>
</ul>
</li>
<li><p>使用步骤</p>
<ol>
<li>第一步为正常的搜索, 但要指定sort值, 并保证值唯一</li>
<li>第二步为使用上一步最后一个文档的sort值进行查询</li>
</ol>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/QEMoWJk5pLH2AFU.jpg"  alt="2020-04-12_031941"></p>
<p>演示:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 2,</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "age": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "birth": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 6,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": null,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "2",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred",</span><br><span class="line">          "job": "java senior engineer and java specialist",</span><br><span class="line">          "age": 28,</span><br><span class="line">          "birth": "1980-05-07",</span><br><span class="line">          "isMarried": true</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          28,</span><br><span class="line">          326505600000</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "4",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred junior way",</span><br><span class="line">          "job": "ruby engineer",</span><br><span class="line">          "age": 23,</span><br><span class="line">          "birth": "1989-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          23,</span><br><span class="line">          618451200000</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 2,</span><br><span class="line">  "search_after": [</span><br><span class="line">    23,</span><br><span class="line">    618451200000</span><br><span class="line">  ],</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "age": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "birth": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 12,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": null,</span><br><span class="line">    "hits": [</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "3",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "lee",</span><br><span class="line">          "job": "java and ruby engineer",</span><br><span class="line">          "age": 22,</span><br><span class="line">          "birth": "1985-08-07",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          22,</span><br><span class="line">          492220800000</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        "_index": "test_search_index",</span><br><span class="line">        "_type": "doc",</span><br><span class="line">        "_id": "1",</span><br><span class="line">        "_score": null,</span><br><span class="line">        "_source": &#123;</span><br><span class="line">          "username": "alfred way",</span><br><span class="line">          "job": "java engineer",</span><br><span class="line">          "age": 18,</span><br><span class="line">          "birth": "1990-01-02",</span><br><span class="line">          "isMarried": false</span><br><span class="line">        &#125;,</span><br><span class="line">        "sort": [</span><br><span class="line">          18,</span><br><span class="line">          631238400000</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 2,</span><br><span class="line">  "search_after": [</span><br><span class="line">    18,</span><br><span class="line">    631238400000</span><br><span class="line">  ],</span><br><span class="line">  "sort": [</span><br><span class="line">    &#123;</span><br><span class="line">      "age": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      "birth": &#123;</span><br><span class="line">        "order": "desc"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 5,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 4,</span><br><span class="line">    "max_score": null,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如何避免深度分页问题?</p>
<ul>
<li>通过唯一排序值定位将每次要处理的文档数都控制在size范围内</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/4FJlm1YtojWaTek.jpg"  alt="2020-04-12_032718"></p>
</li>
</ul>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/12/x7VCKp1MaAFUzuR.jpg"  alt="2020-04-12_032831"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jiavg</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC7%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3Search%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/">https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC7%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3Search%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jiavag.github.io" target="_blank">Jiavg</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a><a class="post-meta__tags" href="/tags/Search%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/">Search运行机制</a></div><div class="post_share"><div class="social-share" data-image="/img/bg/4.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.png" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/12/Elastic%20Search/%E7%AC%AC8%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/"><img class="prev_cover lazyload" data-src="/img/bg/4.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Elasticsearch篇之聚合分析入门</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/11/Elastic%20Search/%E7%AC%AC6%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E5%88%86%E5%B8%83%E5%BC%8F%E7%89%B9%E6%80%A7/"><img class="next_cover lazyload" data-src="/img/bg/10.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Elasticsearch篇之分布式特性</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/01/Elastic Search/1.ElasticSearch与Kibana/" title="ElasticSearch与Kibana入门"><img class="relatedPosts_cover lazyload"data-src="/img/bg/19.jpeg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-01</div><div class="relatedPosts_title">ElasticSearch与Kibana入门</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/16/Elastic Search/第10章-Elasticsearch篇之集群调优建议/" title="Elasticsearch篇之集群调优建议"><img class="relatedPosts_cover lazyload"data-src="/img/bg/4.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-16</div><div class="relatedPosts_title">Elasticsearch篇之集群调优建议</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Elastic Search/4.案例实战/" title="实战-分析Elasticsearch 查询语句"><img class="relatedPosts_cover lazyload"data-src="/img/bg/2.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-04</div><div class="relatedPosts_title">实战-分析Elasticsearch 查询语句</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/09/Elastic Search/第4章-Elasticsearch篇之Mapping设置/" title="Elasticsearch篇之Mapping设置"><img class="relatedPosts_cover lazyload"data-src="/img/bg/2.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-09</div><div class="relatedPosts_title">Elasticsearch篇之Mapping设置</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/11/Elastic Search/第6章-Elasticsearch篇之分布式特性/" title="Elasticsearch篇之分布式特性"><img class="relatedPosts_cover lazyload"data-src="/img/bg/10.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-11</div><div class="relatedPosts_title">Elasticsearch篇之分布式特性</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/09/Elastic Search/第5章-Elasticsearch篇之Search API/" title="Elasticsearch篇之Search API"><img class="relatedPosts_cover lazyload"data-src="/img/bg/16.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-09</div><div class="relatedPosts_title">Elasticsearch篇之Search API</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Jiavg</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>