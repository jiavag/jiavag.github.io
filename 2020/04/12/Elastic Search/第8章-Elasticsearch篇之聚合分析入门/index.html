<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Elasticsearch篇之聚合分析入门 | Jiavg</title><meta name="description" content="Elasticsearch篇之聚合分析入门"><meta name="keywords" content="ElasticSearch,聚合分析"><meta name="author" content="Jiavg"><meta name="copyright" content="Jiavg"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Elasticsearch篇之聚合分析入门"><meta name="twitter:description" content="Elasticsearch篇之聚合分析入门"><meta name="twitter:image" content="https://jiavag.github.io/img/bg/4.png"><meta property="og:type" content="article"><meta property="og:title" content="Elasticsearch篇之聚合分析入门"><meta property="og:url" content="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC8%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/"><meta property="og:site_name" content="Jiavg"><meta property="og:description" content="Elasticsearch篇之聚合分析入门"><meta property="og:image" content="https://jiavag.github.io/img/bg/4.png"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC8%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/"><link rel="prev" title="Redis初识" href="https://jiavag.github.io/2020/04/14/Redis/%E7%AC%AC1%E7%AB%A0-Redis%E5%88%9D%E8%AF%86/"><link rel="next" title="Elasticsearch篇之深入了解Search的运行机制" href="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC7%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3Search%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-6386517046719934',
  enable_page_level_ads: 'true'
});</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://www.lylgjiavg.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: {"languages":{"author":"作者: Jiavg","link":"链接: ","source":"来源: Jiavg","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'true',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">37</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">28</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Elasticsearch篇之聚合分析入门"><span class="toc-number">1.</span> <span class="toc-text">Elasticsearch篇之聚合分析入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是聚合分析"><span class="toc-number">1.1.</span> <span class="toc-text">什么是聚合分析?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#聚合分析"><span class="toc-number">1.2.</span> <span class="toc-text">聚合分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#聚合分析的分类"><span class="toc-number">1.3.</span> <span class="toc-text">聚合分析的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Metric聚合分析"><span class="toc-number">1.3.1.</span> <span class="toc-text">Metric聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Min"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">Min</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Max"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">Max</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Avg"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">Avg</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Sum"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">Sum</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#一次返回多个聚合结果"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">一次返回多个聚合结果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cardinality"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">Cardinality</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stats"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">Stats</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Extended-Stats"><span class="toc-number">1.3.1.8.</span> <span class="toc-text">Extended Stats</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Percentile"><span class="toc-number">1.3.1.9.</span> <span class="toc-text">Percentile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Percentile-Rank"><span class="toc-number">1.3.1.10.</span> <span class="toc-text">Percentile Rank</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Top-Hits"><span class="toc-number">1.3.1.11.</span> <span class="toc-text">Top Hits</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bucket聚合分析"><span class="toc-number">1.3.2.</span> <span class="toc-text">Bucket聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Terms"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">Terms</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Range"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">Range</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Date-Range"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">Date Range</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Histogram"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">Histogram</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Date-Histogram"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">Date Histogram</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Bucket-Metric聚合分析"><span class="toc-number">1.3.3.</span> <span class="toc-text">Bucket + Metric聚合分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pipeline聚合分析"><span class="toc-number">1.3.4.</span> <span class="toc-text">Pipeline聚合分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Pipeline聚合分析分类"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">Pipeline聚合分析分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pipeline聚合分析-Sibling"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">Pipeline聚合分析-Sibling</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Min-Bucket"><span class="toc-number">1.3.4.2.1.</span> <span class="toc-text">Min Bucket</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Max-Bucket"><span class="toc-number">1.3.4.2.2.</span> <span class="toc-text">Max Bucket</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Avg-Bucket"><span class="toc-number">1.3.4.2.3.</span> <span class="toc-text">Avg Bucket</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Sum-Bucket"><span class="toc-number">1.3.4.2.4.</span> <span class="toc-text">Sum Bucket</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stats-Bucket"><span class="toc-number">1.3.4.2.5.</span> <span class="toc-text">Stats Bucket</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Percentiles-Bucket"><span class="toc-number">1.3.4.2.6.</span> <span class="toc-text">Percentiles Bucket</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Pipeline聚合分析-Parent"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">Pipeline聚合分析-Parent</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Derivative"><span class="toc-number">1.3.4.3.1.</span> <span class="toc-text">Derivative</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Moving-Average"><span class="toc-number">1.3.4.3.2.</span> <span class="toc-text">Moving Average</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Cumulative-Sum"><span class="toc-number">1.3.4.3.3.</span> <span class="toc-text">Cumulative Sum</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#作用范围"><span class="toc-number">1.4.</span> <span class="toc-text">作用范围</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#filter"><span class="toc-number">1.4.1.</span> <span class="toc-text">filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#post-filter"><span class="toc-number">1.4.2.</span> <span class="toc-text">post_filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#global"><span class="toc-number">1.4.3.</span> <span class="toc-text">global</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#排序"><span class="toc-number">1.5.</span> <span class="toc-text">排序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#计算精准度问题"><span class="toc-number">1.6.</span> <span class="toc-text">计算精准度问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Terms聚合的执行流程"><span class="toc-number">1.6.1.</span> <span class="toc-text">Terms聚合的执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Terms并不永远准确"><span class="toc-number">1.6.2.</span> <span class="toc-text">Terms并不永远准确</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Terms不准确的解决办法"><span class="toc-number">1.6.3.</span> <span class="toc-text">Terms不准确的解决办法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Shard-Size大小的设定方法"><span class="toc-number">1.6.4.</span> <span class="toc-text">Shard_Size大小的设定方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#近似统计算法"><span class="toc-number">1.7.</span> <span class="toc-text">近似统计算法</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/bg/4.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Jiavg</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> 清单</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Elasticsearch篇之聚合分析入门</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-04-12 23:58:53"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-04-12</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-04-15 01:40:15"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-04-15</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Elastic-Stack/">Elastic Stack</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="Elasticsearch篇之聚合分析入门"><a href="#Elasticsearch篇之聚合分析入门" class="headerlink" title="Elasticsearch篇之聚合分析入门"></a>Elasticsearch篇之聚合分析入门</h1><h2 id="什么是聚合分析"><a href="#什么是聚合分析" class="headerlink" title="什么是聚合分析?"></a>什么是聚合分析?</h2><ul>
<li>搜索引擎用来回答如下问题:<ul>
<li>请告诉我地址为上海的所有订单?</li>
<li>请告诉我最近一天内创建但没有付款的所有订单?</li>
</ul>
</li>
<li>聚合分析可以回答如下问题:<ul>
<li>请告诉我最近一周每天的订单成交量有多少?</li>
<li>请告诉我最近一个月每天的平均订单金额是多少?</li>
<li>请告诉我最近半年卖的最火的前五个商品是哪些?</li>
</ul>
</li>
</ul>
<h2 id="聚合分析"><a href="#聚合分析" class="headerlink" title="聚合分析"></a>聚合分析</h2><ul>
<li><p>聚合分析, 英文名为Aggregation, 是es除了搜索功能外提供的针对es数据做统计分析的功能</p>
<ul>
<li>功能丰富, 提供Bucket, Metric, Pipeline等多种分析方式, 可以满足大部分的分析需求</li>
<li>实用性高, 所有的计算结果都是即时返回的, 而Hadoop等大数据系统一般都是T + 1级别的</li>
</ul>
</li>
<li><p>聚合分析作为search的一部分, api如下所示:</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/3q7GNT4KsvhXjPU.jpg"  alt="2020-04-13_003929"></p>
<p>聚合分析示例用到的索引及其数据:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> aggregation</span></span><br><span class="line">POST test_search_index/doc/_bulk</span><br><span class="line">&#123;"index":&#123;"_id":"1"&#125;&#125;</span><br><span class="line">&#123;"username":"alfred way","job":"java engineer","age":18,"birth":"1990-01-02","isMarried":false,"salary":10000&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"2"&#125;&#125;</span><br><span class="line">&#123;"username":"tom","job":"java senior engineer","age":28,"birth":"1980-05-07","isMarried":true,"salary":30000&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"3"&#125;&#125;</span><br><span class="line">&#123;"username":"lee","job":"ruby engineer","age":22,"birth":"1985-08-07","isMarried":false,"salary":15000&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"4"&#125;&#125;</span><br><span class="line">&#123;"username":"Nick","job":"web engineer","age":23,"birth":"1989-08-07","isMarried":false,"salary":8000&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"5"&#125;&#125;</span><br><span class="line">&#123;"username":"Niko","job":"web engineer","age":18,"birth":"1994-08-07","isMarried":false,"salary":5000&#125;</span><br><span class="line">&#123;"index":&#123;"_id":"6"&#125;&#125;</span><br><span class="line">&#123;"username":"Michell","job":"ruby engineer","age":26,"birth":"1987-08-07","isMarried":false,"salary":12000&#125;</span><br></pre></td></tr></table></figure>

<p>示例:</p>
<p>请告诉我公式目前在职人员工作岗位分布情况?</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/iXyOGabzufTdEjR.jpg"  alt="2020-04-13_004236"></p>
</li>
</ul>
<h2 id="聚合分析的分类"><a href="#聚合分析的分类" class="headerlink" title="聚合分析的分类"></a>聚合分析的分类</h2><ul>
<li>为了便于理解, es将聚合分析主要分为如下4类:<ul>
<li>Bucket         分桶类型, 类似SQL中的Group BY语法</li>
<li>Metric          指标分析类型, 如计算最大值, 最小值, 平均值等等</li>
<li>Pipeline       管道分析类型, 基于上一级的聚合分析结果进行再分析</li>
<li>Matrix          矩阵分析类型</li>
</ul>
</li>
</ul>
<h3 id="Metric聚合分析"><a href="#Metric聚合分析" class="headerlink" title="Metric聚合分析"></a>Metric聚合分析</h3><ul>
<li>主要分如下两类:<ul>
<li>单值分析, 只输出一个分析结果<ul>
<li>min, max, avg, sum</li>
<li>cardinality</li>
</ul>
</li>
<li>多值分析, 输出多个分析结果<ul>
<li>stats, extended stats</li>
<li>percentile, percentile rank</li>
<li>top hits</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Min"><a href="#Min" class="headerlink" title="Min"></a>Min</h4><ul>
<li><p>返回数值类字段的最小值</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/l7qoP9ZcKyH8Mhp.jpg"  alt="2020-04-13_011127"></p>
</li>
</ul>
<h4 id="Max"><a href="#Max" class="headerlink" title="Max"></a>Max</h4><ul>
<li>返回数值类字段的最大值</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/BRMNsUCY9mlgHSe.jpg"  alt="2020-04-13_011619"></p>
<h4 id="Avg"><a href="#Avg" class="headerlink" title="Avg"></a>Avg</h4><ul>
<li><p>返回数值类字段的平均值</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/t5gi8K7vUuJSTeC.jpg"  alt="2020-04-13_011452"></p>
</li>
</ul>
<h4 id="Sum"><a href="#Sum" class="headerlink" title="Sum"></a>Sum</h4><ul>
<li>返回数值类字段的总和</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/7k5RWETgwIXlmhx.jpg"  alt="2020-04-13_011727"></p>
<h4 id="一次返回多个聚合结果"><a href="#一次返回多个聚合结果" class="headerlink" title="一次返回多个聚合结果"></a>一次返回多个聚合结果</h4><p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "max_age": &#123;</span><br><span class="line">      "max": &#123;</span><br><span class="line">        "field": "age"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "mix_age": &#123;</span><br><span class="line">      "min": &#123;</span><br><span class="line">        "field": "age"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "avg_age": &#123;</span><br><span class="line">      "avg": &#123;</span><br><span class="line">        "field": "age"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "sum_age": &#123;</span><br><span class="line">      "sum": &#123;</span><br><span class="line">        "field": "age"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 71,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "max_age": &#123;</span><br><span class="line">      "value": 28</span><br><span class="line">    &#125;,</span><br><span class="line">    "avg_age": &#123;</span><br><span class="line">      "value": 22.5</span><br><span class="line">    &#125;,</span><br><span class="line">    "mix_age": &#123;</span><br><span class="line">      "value": 18</span><br><span class="line">    &#125;,</span><br><span class="line">    "sum_age": &#123;</span><br><span class="line">      "value": 135</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Cardinality"><a href="#Cardinality" class="headerlink" title="Cardinality"></a>Cardinality</h4><ul>
<li><p>Cardinality, 意为集合的势, 或者是基数, 是指不同数值的个数, 类似SQL中的distinct count概念</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/SOETC2tm5lvc9BN.jpg"  alt="2020-04-13_014052"></p>
</li>
</ul>
<h4 id="Stats"><a href="#Stats" class="headerlink" title="Stats"></a>Stats</h4><ul>
<li><p>返回一系列数值类型的统计值, 包含min, max, avg, sum和count</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/bmYonU1Ifd9HQy6.jpg"  alt="2020-04-13_014621"></p>
</li>
</ul>
<h4 id="Extended-Stats"><a href="#Extended-Stats" class="headerlink" title="Extended Stats"></a>Extended Stats</h4><ul>
<li><p>对stats的扩展, 包含了更多的统计数据, 如方差, 标准差等</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/n4heudRgpD7YKIi.jpg"  alt="2020-04-13_014743"></p>
</li>
</ul>
<h4 id="Percentile"><a href="#Percentile" class="headerlink" title="Percentile"></a>Percentile</h4><ul>
<li><p>百分位数统计</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/4mt3h6QEqkVKfJi.jpg"  alt="2020-04-13_014842"></p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "pertile_age": &#123;</span><br><span class="line">      "percentiles": &#123;</span><br><span class="line">        "field": "age",</span><br><span class="line">        "percents": [</span><br><span class="line">          1,</span><br><span class="line">          5,</span><br><span class="line">          25,</span><br><span class="line">          50,</span><br><span class="line">          75,</span><br><span class="line">          95,</span><br><span class="line">          99</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 359,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "pertile_age": &#123;</span><br><span class="line">      "values": &#123;</span><br><span class="line">        "1.0": 17.999999999999996,</span><br><span class="line">        "5.0": 18,</span><br><span class="line">        "25.0": 19,</span><br><span class="line">        "50.0": 22.5,</span><br><span class="line">        "75.0": 25.25,</span><br><span class="line">        "95.0": 27.5,</span><br><span class="line">        "99.0": 27.9</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="Percentile-Rank"><a href="#Percentile-Rank" class="headerlink" title="Percentile Rank"></a>Percentile Rank</h4><ul>
<li><p>百分位数统计</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/mQvFHjdL1SbAstO.jpg"  alt="2020-04-13_014935"></p>
</li>
</ul>
<h4 id="Top-Hits"><a href="#Top-Hits" class="headerlink" title="Top Hits"></a>Top Hits</h4><ul>
<li><p>一般用于分桶后获取该桶内最匹配的顶部文档列表, 即详情数据</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/XxbHE3TU7eQaIF5.jpg"  alt="2020-04-13_015110"></p>
</li>
</ul>
<h3 id="Bucket聚合分析"><a href="#Bucket聚合分析" class="headerlink" title="Bucket聚合分析"></a>Bucket聚合分析</h3><ul>
<li><p>Bucket, 意为桶, 即按照一定的规则文档将文档分配到不同的桶中, 即达到分析的目的</p>
</li>
<li><p>按照Bucket的分桶策略, 常见的Bucket聚合分析如下:</p>
<ul>
<li>Terms</li>
<li>Range</li>
<li>Date Range</li>
<li>Histogram</li>
<li>Date Histogram</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/1h3568YjgL2wpkN.jpg"  alt="2020-04-13_021645"></p>
</li>
</ul>
<h4 id="Terms"><a href="#Terms" class="headerlink" title="Terms"></a>Terms</h4><ul>
<li><p>该分桶策略最简单, 直接按照term来分桶, 如果是text类型, 则按照分词后的结果分桶(注意fielddata需开启)</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/gYiEtKDuSQcr6G1.jpg"  alt="2020-04-13_021840"></p>
</li>
</ul>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 该演示fielddata开启和关闭两种情况的terms分桶策略</span></span><br><span class="line">GET /test_search_index</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 由下可见 test_search_index 索引的job字段的<span class="string">"fielddata"</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> username字段的<span class="string">"fielddata"</span>: <span class="literal">false</span> (未显示即为<span class="literal">false</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  "test_search_index": &#123;</span><br><span class="line">    "aliases": &#123;&#125;,</span><br><span class="line">    "mappings": &#123;</span><br><span class="line">      "doc": &#123;</span><br><span class="line">        "properties": &#123;</span><br><span class="line">          "age": &#123;</span><br><span class="line">            "type": "long"</span><br><span class="line">          &#125;,</span><br><span class="line">          "birth": &#123;</span><br><span class="line">            "type": "date"</span><br><span class="line">          &#125;,</span><br><span class="line">          "isMarried": &#123;</span><br><span class="line">            "type": "boolean"</span><br><span class="line">          &#125;,</span><br><span class="line">          "job": &#123;</span><br><span class="line">            "type": "text",</span><br><span class="line">            "fields": &#123;</span><br><span class="line">              "keyword": &#123;</span><br><span class="line">                "type": "keyword",</span><br><span class="line">                "ignore_above": 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            "fielddata": true</span><br><span class="line">          &#125;,</span><br><span class="line">          "salary": &#123;</span><br><span class="line">            "type": "long"</span><br><span class="line">          &#125;,</span><br><span class="line">          "username": &#123;</span><br><span class="line">            "type": "text",</span><br><span class="line">            "fields": &#123;</span><br><span class="line">              "keyword": &#123;</span><br><span class="line">                "type": "keyword",</span><br><span class="line">                "ignore_above": 256</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "settings": &#123;</span><br><span class="line">      "index": &#123;</span><br><span class="line">        "creation_date": "1586715804177",</span><br><span class="line">        "number_of_shards": "5",</span><br><span class="line">        "number_of_replicas": "1",</span><br><span class="line">        "uuid": "FiiZo7rFQMCXRqwThmSlEw",</span><br><span class="line">        "version": &#123;</span><br><span class="line">          "created": "6010199"</span><br><span class="line">        &#125;,</span><br><span class="line">        "provided_name": "test_search_index"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 接下来对该两个字段进行terms分桶操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对username字段进行terms分桶操作</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "terms_username": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "username",</span><br><span class="line">        "size": 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可见由于username字段未开启Fielddata, 就报错误信息</span></span><br><span class="line">&#123;</span><br><span class="line">  "error": &#123;</span><br><span class="line">    "root_cause": [</span><br><span class="line">      &#123;</span><br><span class="line">        "type": "illegal_argument_exception",</span><br><span class="line">        "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [username] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    "type": "search_phase_execution_exception",</span><br><span class="line">    "reason": "all shards failed",</span><br><span class="line">    "phase": "query",</span><br><span class="line">    "grouped": true,</span><br><span class="line">    "failed_shards": [</span><br><span class="line">      &#123;</span><br><span class="line">        "shard": 0,</span><br><span class="line">        "index": "test_search_index",</span><br><span class="line">        "node": "WIUsESqiTZqLs_4nQTvbeQ",</span><br><span class="line">        "reason": &#123;</span><br><span class="line">          "type": "illegal_argument_exception",</span><br><span class="line">          "reason": "Fielddata is disabled on text fields by default. Set fielddata=true on [username] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead."</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  "status": 400</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对job字段进行terms分桶操作</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "terms_job": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "job",</span><br><span class="line">        "size": 10</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 由于job字段开启了Fielddata, 即可以正确进行terms分桶操作</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 153,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "terms_job": &#123;</span><br><span class="line">      "doc_count_error_upper_bound": 0,</span><br><span class="line">      "sum_other_doc_count": 0,</span><br><span class="line">      "buckets": [</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "engineer",</span><br><span class="line">          "doc_count": 6</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "java",</span><br><span class="line">          "doc_count": 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "ruby",</span><br><span class="line">          "doc_count": 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "web",</span><br><span class="line">          "doc_count": 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "senior",</span><br><span class="line">          "doc_count": 1</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h4><ul>
<li><p>通过制定数值的范围来设定分桶规则</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/14r2ca9JBOPNoFw.jpg"  alt="2020-04-13_023403"></p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当指定key时, es就不会生成默认的key</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "salary_range": &#123;</span><br><span class="line">      "range": &#123;</span><br><span class="line">        "field": "salary",</span><br><span class="line">        "ranges": [</span><br><span class="line">          &#123;</span><br><span class="line">            "key": "glt 10000", </span><br><span class="line">            "from": 0,</span><br><span class="line">            "to": 10000</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            "key": "glt 20000", </span><br><span class="line">            "from": 10000,</span><br><span class="line">            "to": 20000</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            "key": "glt 30000", </span><br><span class="line">            "from": 20000,</span><br><span class="line">            "to": 30000</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 53,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "salary_range": &#123;</span><br><span class="line">      "buckets": [</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "glt 10000",</span><br><span class="line">          "from": 0,</span><br><span class="line">          "to": 10000,</span><br><span class="line">          "doc_count": 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "glt 20000",</span><br><span class="line">          "from": 10000,</span><br><span class="line">          "to": 20000,</span><br><span class="line">          "doc_count": 3</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "glt 30000",</span><br><span class="line">          "from": 20000,</span><br><span class="line">          "to": 30000,</span><br><span class="line">          "doc_count": 0</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="Date-Range"><a href="#Date-Range" class="headerlink" title="Date Range"></a>Date Range</h4><ul>
<li><p>通过指定日期范围来设定分桶规则</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/vXQzAPocOkVmZxG.jpg"  alt="2020-04-13_024056"></p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "birth_range": &#123;</span><br><span class="line">      "date_range": &#123;</span><br><span class="line">        "field": "birth",</span><br><span class="line">        "format": "yyyy", </span><br><span class="line">        "ranges": [</span><br><span class="line">          &#123;</span><br><span class="line">            "from": "1980",</span><br><span class="line">            "to": "1990"</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123;</span><br><span class="line">            "from": "1900",</span><br><span class="line">            "to": "2000"</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 153,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "birth_range": &#123;</span><br><span class="line">      "buckets": [</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "1900-2000",</span><br><span class="line">          "from": -2208988800000,</span><br><span class="line">          "from_as_string": "1900",</span><br><span class="line">          "to": 946684800000,</span><br><span class="line">          "to_as_string": "2000",</span><br><span class="line">          "doc_count": 6</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "1980-1990",</span><br><span class="line">          "from": 315532800000,</span><br><span class="line">          "from_as_string": "1980",</span><br><span class="line">          "to": 631152000000,</span><br><span class="line">          "to_as_string": "1990",</span><br><span class="line">          "doc_count": 4</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h4 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h4><ul>
<li>直方图, 以固定间隔的策略来分割数据</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/YBLwartUhvxfsA2.jpg"  alt="2020-04-13_024227"></p>
<h4 id="Date-Histogram"><a href="#Date-Histogram" class="headerlink" title="Date Histogram"></a>Date Histogram</h4><ul>
<li><p>针对日期的直方图或者柱状图, 是时序数据分析中常用的聚合分析类型</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/eGCjvFPMYTBnwIr.jpg"  alt="2020-04-13_024931"></p>
</li>
</ul>
<h3 id="Bucket-Metric聚合分析"><a href="#Bucket-Metric聚合分析" class="headerlink" title="Bucket + Metric聚合分析"></a>Bucket + Metric聚合分析</h3><ul>
<li><p>Bucket 聚合分析允许通过添加子分析来进一步进行分析, 该子分析可以是Bucket也可以是Metric.这也使得es的聚合分析能力变得异常强大</p>
<p>示例:</p>
<p>分桶之后再分桶:</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/GBsr7DHpkK26axU.jpg"  alt="2020-04-13_030059"></p>
<p>分桶之后进行数据分析:</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/dqR9MKJTPXt48Qs.jpg"  alt="2020-04-13_030233"></p>
</li>
</ul>
<h3 id="Pipeline聚合分析"><a href="#Pipeline聚合分析" class="headerlink" title="Pipeline聚合分析"></a>Pipeline聚合分析</h3><ul>
<li><p>针对聚合分析的结果再次进行聚合分析, 而且支持链式调用, 可以回答如下问题:</p>
<ul>
<li>订单的月平均销售额是多少?</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/bg2oOmB1ty5vpPA.jpg"  alt="2020-04-13_153429"></p>
</li>
</ul>
<h4 id="Pipeline聚合分析分类"><a href="#Pipeline聚合分析分类" class="headerlink" title="Pipeline聚合分析分类"></a>Pipeline聚合分析分类</h4><ul>
<li>Pipeline的分析结果会输出到原结果中, 根据输出位置不同, 分为以下两类:<ul>
<li>Parent     结果内嵌到现有的聚合分析结果中<ul>
<li>Derivative</li>
<li>Moving Average</li>
<li>Cumulative Sum</li>
</ul>
</li>
<li>Sibling     结果与现有聚合分析结果同级<ul>
<li>Max/Min/Avg/Sum Bucket</li>
<li>Stats/Extended Stats Bucket</li>
<li>Percentiles Bucket</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="Pipeline聚合分析-Sibling"><a href="#Pipeline聚合分析-Sibling" class="headerlink" title="Pipeline聚合分析-Sibling"></a>Pipeline聚合分析-Sibling</h4><h5 id="Min-Bucket"><a href="#Min-Bucket" class="headerlink" title="Min Bucket"></a>Min Bucket</h5><ul>
<li><p>找出所有Bucket中值最小的Bucket名称和值</p>
<p>  <img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/jEH4bQ5evnSop6C.jpg"  alt="2020-04-13_155253"></p>
</li>
</ul>
<p>​    示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "job_terms": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "job.keyword"</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "avg_salary": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "salary"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "min_avg_salary": &#123;</span><br><span class="line">      "min_bucket": &#123;</span><br><span class="line">        "buckets_path": "job_terms&gt;avg_salary"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 57,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "job_terms": &#123;</span><br><span class="line">      "doc_count_error_upper_bound": 0,</span><br><span class="line">      "sum_other_doc_count": 0,</span><br><span class="line">      "buckets": [</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "ruby engineer",</span><br><span class="line">          "doc_count": 2,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 13500</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "web engineer",</span><br><span class="line">          "doc_count": 2,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 6500</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "java engineer",</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 10000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "java senior engineer",</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 30000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    "min_avg_salary": &#123;</span><br><span class="line">      "value": 6500,</span><br><span class="line">      "keys": [</span><br><span class="line">        "web engineer"</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Max-Bucket"><a href="#Max-Bucket" class="headerlink" title="Max Bucket"></a>Max Bucket</h5><ul>
<li>找出所有Bucket中值最大的Bucket名称和值<br><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/J9Gk5Nc6UjMYOKD.jpg"  alt="2020-04-13_155849"></li>
</ul>
<h5 id="Avg-Bucket"><a href="#Avg-Bucket" class="headerlink" title="Avg Bucket"></a>Avg Bucket</h5><ul>
<li><p>计算所有Bucket的平均值</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/pqU6doARVKr5Hfm.jpg"  alt="2020-04-13_160026"></p>
</li>
</ul>
<h5 id="Sum-Bucket"><a href="#Sum-Bucket" class="headerlink" title="Sum Bucket"></a>Sum Bucket</h5><ul>
<li><p>计算所有Bucket值的总和</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/79hEJiQ1MGuOpxc.jpg"  alt="2020-04-13_160217"></p>
</li>
</ul>
<h5 id="Stats-Bucket"><a href="#Stats-Bucket" class="headerlink" title="Stats Bucket"></a>Stats Bucket</h5><ul>
<li><p>计算所有Bucket值的Stats分析</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/E6w84t5mdZuTxjC.jpg"  alt="2020-04-13_160408"></p>
<p>示例:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "job_terms": &#123;</span><br><span class="line">      "terms": &#123;</span><br><span class="line">        "field": "job.keyword"</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "avg_salary": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "salary"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "stats_avg_salary": &#123;</span><br><span class="line">      "stats_bucket": &#123;</span><br><span class="line">        "buckets_path": "job_terms&gt;avg_salary"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 45,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "job_terms": &#123;</span><br><span class="line">      "doc_count_error_upper_bound": 0,</span><br><span class="line">      "sum_other_doc_count": 0,</span><br><span class="line">      "buckets": [</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "ruby engineer",</span><br><span class="line">          "doc_count": 2,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 13500</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "web engineer",</span><br><span class="line">          "doc_count": 2,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 6500</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "java engineer",</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 10000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key": "java senior engineer",</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 30000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    "stats_avg_salary": &#123;</span><br><span class="line">      "count": 4,</span><br><span class="line">      "min": 6500,</span><br><span class="line">      "max": 30000,</span><br><span class="line">      "avg": 15000,</span><br><span class="line">      "sum": 60000</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h5 id="Percentiles-Bucket"><a href="#Percentiles-Bucket" class="headerlink" title="Percentiles Bucket"></a>Percentiles Bucket</h5><ul>
<li><p>计算所有Bucket值的百分数</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/nNmpakliFKHO93S.jpg"  alt="2020-04-13_161054"></p>
</li>
</ul>
<h4 id="Pipeline聚合分析-Parent"><a href="#Pipeline聚合分析-Parent" class="headerlink" title="Pipeline聚合分析-Parent"></a>Pipeline聚合分析-Parent</h4><h5 id="Derivative"><a href="#Derivative" class="headerlink" title="Derivative"></a>Derivative</h5><ul>
<li><p>计算Bucket值的导数</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/kUgQjaz9eLlorcx.jpg"  alt="2020-04-13_161317" style="zoom:50%;" />

</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> request</span></span><br><span class="line">GET /test_search_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  "size": 0,</span><br><span class="line">  "aggs": &#123;</span><br><span class="line">    "birth_histogram": &#123;</span><br><span class="line">      "date_histogram": &#123;</span><br><span class="line">        "field": "birth",</span><br><span class="line">        "interval": "year"</span><br><span class="line">      &#125;,</span><br><span class="line">      "aggs": &#123;</span><br><span class="line">        "avg_salary": &#123;</span><br><span class="line">          "avg": &#123;</span><br><span class="line">            "field": "salary"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        "derivative_avg_salary": &#123;</span><br><span class="line">          "derivative": &#123;</span><br><span class="line">            "buckets_path": "avg_salary"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> response</span></span><br><span class="line">&#123;</span><br><span class="line">  "took": 155,</span><br><span class="line">  "timed_out": false,</span><br><span class="line">  "_shards": &#123;</span><br><span class="line">    "total": 5,</span><br><span class="line">    "successful": 5,</span><br><span class="line">    "skipped": 0,</span><br><span class="line">    "failed": 0</span><br><span class="line">  &#125;,</span><br><span class="line">  "hits": &#123;</span><br><span class="line">    "total": 6,</span><br><span class="line">    "max_score": 0,</span><br><span class="line">    "hits": []</span><br><span class="line">  &#125;,</span><br><span class="line">  "aggregations": &#123;</span><br><span class="line">    "birth_histogram": &#123;</span><br><span class="line">      "buckets": [</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1980-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 315532800000,</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 30000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1981-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 347155200000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1982-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 378691200000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1983-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 410227200000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1984-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 441763200000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1985-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 473385600000,</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 15000</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1986-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 504921600000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1987-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 536457600000,</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 12000</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1988-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 567993600000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1989-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 599616000000,</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 8000</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1990-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 631152000000,</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 10000</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": 2000</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1991-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 662688000000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1992-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 694224000000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1993-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 725846400000,</span><br><span class="line">          "doc_count": 0,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          "key_as_string": "1994-01-01T00:00:00.000Z",</span><br><span class="line">          "key": 757382400000,</span><br><span class="line">          "doc_count": 1,</span><br><span class="line">          "avg_salary": &#123;</span><br><span class="line">            "value": 5000</span><br><span class="line">          &#125;,</span><br><span class="line">          "derivative_avg_salary": &#123;</span><br><span class="line">            "value": null</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Moving-Average"><a href="#Moving-Average" class="headerlink" title="Moving Average"></a>Moving Average</h5><ul>
<li><p>计算Bucket值的移动平均值</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/eL9Kazs6DPTXZcV.jpg"  alt="2020-04-13_162110" style="zoom:50%;" />

</li>
</ul>
<h5 id="Cumulative-Sum"><a href="#Cumulative-Sum" class="headerlink" title="Cumulative Sum"></a>Cumulative Sum</h5><ul>
<li><p>计算Bucket值的累积加和</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/ZQxD5gK3iUvVnfC.jpg"  alt="2020-04-13_162311" style="zoom:50%;" />



</li>
</ul>
<h2 id="作用范围"><a href="#作用范围" class="headerlink" title="作用范围"></a>作用范围</h2><ul>
<li>es聚合分析默认作用范围是query的结果集, 可以通过如下的方式改变其作用范围:<ul>
<li>filter</li>
<li>post_filter</li>
<li>global</li>
</ul>
</li>
</ul>
<h3 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h3><ul>
<li><p>为某个聚集分析设定过滤条件, 从而在不更改整体query语句的情况下修改了作用范围</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/Nx54gFkmi8hzY23.jpg"  alt="2020-04-13_234132"></p>
</li>
</ul>
<h3 id="post-filter"><a href="#post-filter" class="headerlink" title="post_filter"></a>post_filter</h3><ul>
<li><p>作用于文档过滤, 但在聚合分析后生效</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/9xECDtb15F2dXmo.jpg"  alt="2020-04-13_235142"></p>
</li>
</ul>
<h3 id="global"><a href="#global" class="headerlink" title="global"></a>global</h3><ul>
<li><p>无视query过滤条件, 基于全部文档进行分析</p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/13/J4ztoZFMKDbBQYG.jpg"  alt="2020-04-13_235916"></p>
</li>
</ul>
<h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><ul>
<li><p>可以使用自带的关键数据进行排序, 比如:</p>
<ul>
<li>_count      文档数</li>
<li>_key          按照key值排序</li>
</ul>
<p>例1:</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/zc9ESYTWvIfAQH4.jpg"  alt="2020-04-14_000849" style="zoom:50%;" />

<p>例2:</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/9GN7eSjUg45QEfZ.jpg"  alt="2020-04-14_000956" style="zoom:80%;" />



</li>
</ul>
<h2 id="计算精准度问题"><a href="#计算精准度问题" class="headerlink" title="计算精准度问题"></a>计算精准度问题</h2><h3 id="Terms聚合的执行流程"><a href="#Terms聚合的执行流程" class="headerlink" title="Terms聚合的执行流程"></a>Terms聚合的执行流程</h3><p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/dQrgGvlDUR3AaTk.jpg"  alt="2020-04-14_003313"></p>
<h3 id="Terms并不永远准确"><a href="#Terms并不永远准确" class="headerlink" title="Terms并不永远准确"></a>Terms并不永远准确</h3><p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/VGocrbLyF3sZ51R.jpg"  alt="2020-04-14_003438"></p>
<h3 id="Terms不准确的解决办法"><a href="#Terms不准确的解决办法" class="headerlink" title="Terms不准确的解决办法"></a>Terms不准确的解决办法</h3><ul>
<li><p>设置shard数为1, 消除数据分散的问题, 但无法承载大数据量</p>
</li>
<li><p>合理设置Shard_Size大小, 即每次从Shard上额外多获取数据, 以提升准确度</p>
<img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/qkDdfamG21YWTZ7.jpg"  alt="2020-04-14_003856" style="zoom:50%;" />

</li>
</ul>
<h3 id="Shard-Size大小的设定方法"><a href="#Shard-Size大小的设定方法" class="headerlink" title="Shard_Size大小的设定方法"></a>Shard_Size大小的设定方法</h3><ul>
<li><p>terms聚合分析结果中有如下两个统计值</p>
<ul>
<li>doc_count_error_upper_bound  被遗漏的term可能的最大值</li>
<li>sum_other_doc_count                  返回结果bucket的term外其他term的文档总数</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/tUOFE1THwZ4oDyx.jpg"  alt="2020-04-14_004154"></p>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/BV5KpuwxcA6tH4W.jpg"  alt="2020-04-14_004256"></p>
</li>
<li><p>Shard_Size默认大小如下:</p>
<ul>
<li>shard_size = (size * 1.5) + 10</li>
</ul>
</li>
<li><p>通过调整Shard_Size的大小降低 doc_count_error_upper_bound  来提升准确度</p>
<ul>
<li>增大了整体的计算量, 从而降低了响应时间</li>
</ul>
</li>
</ul>
<h2 id="近似统计算法"><a href="#近似统计算法" class="headerlink" title="近似统计算法"></a>近似统计算法</h2><ul>
<li><p>在es的聚合分析中, Cardinality和Percentile分析使用的是近似统计算法</p>
<ul>
<li>结果是近似准确的, 但不一定精准</li>
<li>可以通过参数的调整使其结果精准, 但同时也意味着更多的计算时间和更大的性能消耗</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://i.loli.net/2020/04/14/BfQT8zH1p2jyiLl.jpg"  alt="2020-04-14_004924"></p>
</li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Jiavg</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC8%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/">https://jiavag.github.io/2020/04/12/Elastic%20Search/%E7%AC%AC8%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90%E5%85%A5%E9%97%A8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://jiavag.github.io" target="_blank">Jiavg</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a><a class="post-meta__tags" href="/tags/%E8%81%9A%E5%90%88%E5%88%86%E6%9E%90/">聚合分析</a></div><div class="post_share"><div class="social-share" data-image="/img/bg/17.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.png" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.png" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/04/14/Redis/%E7%AC%AC1%E7%AB%A0-Redis%E5%88%9D%E8%AF%86/"><img class="prev_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Redis初识</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/12/Elastic%20Search/%E7%AC%AC7%E7%AB%A0-Elasticsearch%E7%AF%87%E4%B9%8B%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3Search%E7%9A%84%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/"><img class="next_cover lazyload" data-src="/img/bg/15.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Elasticsearch篇之深入了解Search的运行机制</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2020/04/01/Elastic Search/1.ElasticSearch与Kibana/" title="ElasticSearch与Kibana入门"><img class="relatedPosts_cover lazyload"data-src="/img/bg/11.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-01</div><div class="relatedPosts_title">ElasticSearch与Kibana入门</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/04/Elastic Search/4.案例实战/" title="实战-分析Elasticsearch 查询语句"><img class="relatedPosts_cover lazyload"data-src="/img/bg/6.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-04</div><div class="relatedPosts_title">实战-分析Elasticsearch 查询语句</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/16/Elastic Search/第10章-Elasticsearch篇之集群调优建议/" title="Elasticsearch篇之集群调优建议"><img class="relatedPosts_cover lazyload"data-src="/img/bg/10.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-16</div><div class="relatedPosts_title">Elasticsearch篇之集群调优建议</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/09/Elastic Search/第4章-Elasticsearch篇之Mapping设置/" title="Elasticsearch篇之Mapping设置"><img class="relatedPosts_cover lazyload"data-src="/img/bg/5.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-09</div><div class="relatedPosts_title">Elasticsearch篇之Mapping设置</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/08/Elastic Search/第3章-Elasticsearch篇之倒排索引与分词/" title="Elasticsearch篇之倒排索引与分词"><img class="relatedPosts_cover lazyload"data-src="/img/bg/7.png"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-08</div><div class="relatedPosts_title">Elasticsearch篇之倒排索引与分词</div></div></a></div><div class="relatedPosts_item"><a href="/2020/04/11/Elastic Search/第6章-Elasticsearch篇之分布式特性/" title="Elasticsearch篇之分布式特性"><img class="relatedPosts_cover lazyload"data-src="/img/bg/11.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-11</div><div class="relatedPosts_title">Elasticsearch篇之分布式特性</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Jiavg</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>